#  整数溢出笔记：int运算赋值给long long

## 核心问题

**即使结果变量是 `long long`，如果运算过程中操作数是 `int` 类型，运算会先在 `int` 范围内完成，然后才转换为 `long long`。此时如果中间结果超过 `int` 范围就会溢出。**

## 典型案例

### 案例1：平方计算

```cpp
int i = 100000;
long long result = i * i;  // ❌ 溢出！
// i * i 先按 int 计算 = 10,000,000,000，超过 int 最大值 2,147,483,647
```

**正确写法：**

```cpp
long long result = (long long)i * i;  // ✅ 第一个操作数转换后整个表达式提升
// 或
long long result = 1LL * i * i;       // ✅ 使用 long long 字面量
```

### 案例2：连乘表达式

```cpp
int n = 10000;
long long sum = n * n * (n * n - 1) / 2;  // ❌ 可能溢出
```

**分析：**

- `n * n` = 100,000,000 (在int范围内)
- `n * n - 1` = 99,999,999 (在int范围内)
- `n * n * (n * n - 1)` ≈ 10^16 (超出int范围！)

**正确写法：**

```cpp
long long nn = (long long)n * n;
long long sum = nn * (nn - 1) / 2;  // ✅
```

### 案例3：组合数计算

```cpp
int n = 50000, k = 2;
long long result = n * (n - 1) / k;  // ❌ n*(n-1) 可能溢出
```

**正确写法：**

```cpp
long long result = (long long)n * (n - 1) / k;  // ✅
```

## 关键规则

### 1. 类型提升时机

- **赋值不会提前类型提升**：`long long x = a * b` 中，如果 a、b 都是 int，乘法会先按 int 执行
- **需要显式转换**：至少一个操作数转为 `long long`，整个表达式才会提升

### 2. 常用转换技巧

```cpp
// 方法1：强制类型转换
long long result = (long long)a * b;

// 方法2：使用字面量
long long result = 1LL * a * b;

// 方法3：提前转换变量
long long la = a;
long long result = la * b;
```

### 3. int 和 long long 的范围

- `int`: -2,147,483,648 ~ 2,147,483,647 (约 ±2.1 × 10^9)
- `long long`: -9,223,372,036,854,775,808 ~ 9,223,372,036,854,775,807 (约 ±9.2 × 10^18)

## 实战检查清单

遇到以下情况需警惕溢出：

- ✅ 两个 int 相乘，结果可能超过 2×10^9
- ✅ 连乘超过两项
- ✅ 平方运算：i > 46340 时 i² 会溢出
- ✅ 组合数、阶乘相关计算
- ✅ 几何级数求和

## 调试技巧

```cpp
// 添加断言检查
#include <cassert>
int a = 100000, b = 100000;
assert(a <= INT_MAX / b);  // 检查乘法是否会溢出
long long result = (long long)a * b;
```

## 总结

**记住：类型转换要在运算之前，而不是赋值时！**

当有任何 int 运算可能超过 ±2.1×10^9 时，务必确保至少一个操作数是 `long long` 类型